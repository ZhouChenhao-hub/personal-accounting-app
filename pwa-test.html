<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA å®‰è£…æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ccc;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .btn {
            background: #0d6efd;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0b5ed7; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ’° PWA å®‰è£…æµ‹è¯•</h1>
    
    <div id="status-container">
        <h2>æ£€æŸ¥ PWA å®‰è£…æ¡ä»¶</h2>
        <div id="status-list"></div>
    </div>
    
    <div>
        <h2>æ‰‹åŠ¨æ“ä½œ</h2>
        <button id="installBtn" class="btn" onclick="manualInstall()" disabled>æ‰‹åŠ¨å®‰è£… PWA</button>
        <button id="checkBtn" class="btn" onclick="checkPWAStatus()">é‡æ–°æ£€æŸ¥</button>
        <button id="clearBtn" class="btn" onclick="clearData()">æ¸…é™¤ç¼“å­˜</button>
    </div>
    
    <div>
        <h2>è°ƒè¯•ä¿¡æ¯</h2>
        <pre id="debug-info"></pre>
    </div>

    <script>
        let deferredPrompt = null;
        let debugInfo = [];

        function log(message) {
            debugInfo.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            document.getElementById('debug-info').textContent = debugInfo.join('\n');
            console.log(message);
        }

        function addStatus(message, type = 'info') {
            const statusList = document.getElementById('status-list');
            const item = document.createElement('div');
            item.className = `status-item ${type}`;
            item.textContent = message;
            statusList.appendChild(item);
        }

        function clearStatus() {
            document.getElementById('status-list').innerHTML = '';
        }

        async function checkPWAStatus() {
            clearStatus();
            log('å¼€å§‹æ£€æŸ¥ PWA çŠ¶æ€...');

            // æ£€æŸ¥ HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                addStatus('âœ… HTTPS æˆ– localhost - æ­£å¸¸', 'success');
            } else {
                addStatus('âŒ éœ€è¦ HTTPS æˆ– localhost', 'error');
            }

            // æ£€æŸ¥ Service Worker æ”¯æŒ
            if ('serviceWorker' in navigator) {
                addStatus('âœ… Service Worker æ”¯æŒ - æ­£å¸¸', 'success');
                
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    addStatus('âœ… Service Worker æ³¨å†ŒæˆåŠŸ', 'success');
                    log(`Service Worker æ³¨å†ŒæˆåŠŸ: ${registration.scope}`);
                } catch (error) {
                    addStatus('âŒ Service Worker æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
                    log(`Service Worker æ³¨å†Œå¤±è´¥: ${error}`);
                }
            } else {
                addStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒ Service Worker', 'error');
            }

            // æ£€æŸ¥ manifest
            try {
                const response = await fetch('./manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    addStatus('âœ… Manifest æ–‡ä»¶å¯è®¿é—®', 'success');
                    log('Manifest å†…å®¹: ' + JSON.stringify(manifest, null, 2));
                } else {
                    addStatus('âŒ Manifest æ–‡ä»¶æ— æ³•è®¿é—®', 'error');
                }
            } catch (error) {
                addStatus('âŒ Manifest è·å–å¤±è´¥: ' + error.message, 'error');
            }

            // æ£€æŸ¥å›¾æ ‡
            const iconSizes = ['192', '512'];
            for (const size of iconSizes) {
                try {
                    const response = await fetch(`./icon-${size}.png`);
                    if (response.ok) {
                        addStatus(`âœ… å›¾æ ‡ ${size}x${size} å­˜åœ¨`, 'success');
                    } else {
                        addStatus(`âŒ å›¾æ ‡ ${size}x${size} ä¸å­˜åœ¨`, 'error');
                    }
                } catch (error) {
                    addStatus(`âŒ å›¾æ ‡ ${size}x${size} æ£€æŸ¥å¤±è´¥`, 'error');
                }
            }

            // æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
            if (window.matchMedia('(display-mode: standalone)').matches) {
                addStatus('âœ… åº”ç”¨å·²å®‰è£…ï¼ˆstandalone æ¨¡å¼ï¼‰', 'success');
            } else {
                addStatus('â„¹ï¸ åº”ç”¨æœªå®‰è£…', 'warning');
            }

            // æ£€æŸ¥å®‰è£…æç¤º
            if (deferredPrompt) {
                addStatus('âœ… å®‰è£…æç¤ºå·²å‡†å¤‡', 'success');
                document.getElementById('installBtn').disabled = false;
            } else {
                addStatus('âš ï¸ å®‰è£…æç¤ºæœªå‡†å¤‡ï¼ˆå¯èƒ½å·²å®‰è£…æˆ–æ¡ä»¶ä¸æ»¡è¶³ï¼‰', 'warning');
            }
        }

        function manualInstall() {
            if (deferredPrompt) {
                log('è§¦å‘å®‰è£…æç¤º...');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        log('ç”¨æˆ·æ¥å—äº†å®‰è£…');
                        addStatus('âœ… ç”¨æˆ·åŒæ„å®‰è£…', 'success');
                    } else {
                        log('ç”¨æˆ·æ‹’ç»äº†å®‰è£…');
                        addStatus('âŒ ç”¨æˆ·æ‹’ç»å®‰è£…', 'warning');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBtn').disabled = true;
                });
            } else {
                alert('å®‰è£…æç¤ºä¸å¯ç”¨ã€‚è¯·ç¡®ä¿æ»¡è¶³æ‰€æœ‰ PWA æ¡ä»¶ã€‚');
            }
        }

        async function clearData() {
            log('æ¸…é™¤ç¼“å­˜æ•°æ®...');
            
            // æ¸…é™¤ Service Worker ç¼“å­˜
            if ('serviceWorker' in navigator) {
                const cacheNames = await caches.keys();
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    log(`å·²åˆ é™¤ç¼“å­˜: ${cacheName}`);
                }
                
                // å¸è½½ Service Worker
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                    log('å·²å¸è½½ Service Worker');
                }
            }
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.clear();
            sessionStorage.clear();
            log('å·²æ¸…é™¤æœ¬åœ°å­˜å‚¨');
            
            alert('ç¼“å­˜å·²æ¸…é™¤ï¼Œé¡µé¢å°†é‡æ–°åŠ è½½');
            window.location.reload();
        }

        // ç›‘å¬å®‰è£…æç¤ºäº‹ä»¶
        window.addEventListener('beforeinstallprompt', (e) => {
            log('æ”¶åˆ°å®‰è£…æç¤ºäº‹ä»¶');
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').disabled = false;
            addStatus('âœ… å®‰è£…æç¤ºå·²æ•è·', 'success');
        });

        // ç›‘å¬å®‰è£…å®Œæˆäº‹ä»¶
        window.addEventListener('appinstalled', (evt) => {
            log('åº”ç”¨å®‰è£…å®Œæˆ');
            addStatus('âœ… åº”ç”¨å®‰è£…æˆåŠŸï¼', 'success');
            deferredPrompt = null;
            document.getElementById('installBtn').disabled = true;
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            checkPWAStatus();
        });
    </script>
</body>
</html> 